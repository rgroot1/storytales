{% extends "base.html" %}

{% block title %}Create Story - StoryTales{% endblock %}

{% block content %}
<div class="story-creator">
    <h1>Create Your Story Adventure!</h1>
    <div class="input-field">
        <div class="age-group-selector">
            <label for="ageGroup">Age Group (optional)</label>
            <select id="ageGroup" class="age-select">
                <option value="baby">Baby & Toddler (ages 0-3)</option>
                <option value="preK" selected>Pre-K (ages 3-5)</option>
                <option value="growing">Growing Reader (ages 5-7)</option>
            </select>
        </div>
        
        <div class="main-prompt-section">
            <label for="mainPrompt" class="required-label">
                What's the adventure of your hero? Feel free to add any exciting details!
            </label>
            <textarea 
                id="mainPrompt" 
                class="materialize-textarea" 
                required 
                placeholder="e.g. an owl gets lost while searching for her mushroom"
            ></textarea>
        </div>
        
        <button id="tell-more-btn" class="secondary-button" onclick="toggleAdditionalFields()">
            More Options <i class="fas fa-chevron-down"></i>
        </button>
        
        <div id="additional-fields" class="additional-fields">
            <div class="input-field">
                <label for="moral">What's the moral of the story?</label>
                <textarea id="moral" class="materialize-textarea"
                    placeholder="e.g. Kindness | Bravery | Sharing | Other"
                ></textarea>
            </div>
            <div class="input-field">
                <label for="creature">Add a friend or sidekick</label>
                <textarea id="creature" class="materialize-textarea"
                    placeholder="e.g. a firefly"
                ></textarea>
            </div>
            <div class="input-field">
                <label for="magic">Sprinkle in magic or a fun detail</label>
                <textarea id="magic" class="materialize-textarea"
                    placeholder="e.g. the firefly can guide lost creatures through the forest with its magical light"
                ></textarea>
            </div>
            <div class="input-field">
                <label for="vibe">Pick a vibe/setting:</label>
                <textarea id="vibe" class="materialize-textarea"
                    placeholder="Silly üé™ | Heartwarming ‚ù§Ô∏è | Adventurous üåü | Peaceful üçÉ"
                ></textarea>
            </div>
        </div>
        
        <button id="generate-btn" onclick="generateStory()" class="generate-button">
            <span class="button-text">Generate Story</span>
            <div class="button-loader" style="display: none;"></div>
        </button>
    </div>
    
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Creating your story...</p>
    </div>

    <div id="error-message" class="error-message" style="display: none;"></div>
    
    <div id="story-output" class="story-output" style="display: none;">
        <h2>Your Story</h2>
        <div id="story-content"></div>
        <div id="incomplete-warning" class="warning-message" style="display: none;">
            <p>‚ö†Ô∏è It seems the story might be incomplete. Would you like to:</p>
            <button onclick="regenerateStory()" class="secondary-button">
                Generate a shorter version
            </button>
        </div>
    </div>
</div>

<script>
function toggleAdditionalFields() {
    const additionalFields = document.getElementById('additional-fields');
    const button = document.getElementById('tell-more-btn');
    const icon = button.querySelector('i');
    
    if (!additionalFields.classList.contains('visible')) {
        additionalFields.classList.add('visible');
        additionalFields.style.display = 'block';
        setTimeout(() => additionalFields.style.opacity = '1', 10);
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
    } else {
        additionalFields.style.opacity = '0';
        setTimeout(() => {
            additionalFields.classList.remove('visible');
            additionalFields.style.display = 'none';
        }, 300);
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    }
}

function checkStoryCompletion(story) {
    // Check for common incomplete endings
    const incompleteMarkers = [
        '...',
        'suddenly',
        'then',
        'and then'
    ];
    
    const lastFewWords = story.slice(-50).toLowerCase();
    return !incompleteMarkers.some(marker => 
        lastFewWords.endsWith(marker) || 
        lastFewWords.endsWith(marker + '.')
    );
}

async function regenerateStory() {
    // Add length constraint to the prompt
    const promptData = {
        ...window.currentPromptData,  // Store the last used prompt data
        constrainLength: true  // Add flag for shorter story
    };
    await generateStory(promptData);
}

async function generateStory(customData) {
    // Allow passing custom data for regeneration
    let promptData = customData || {};
    
    const mainPrompt = document.getElementById('mainPrompt').value.trim();
    const ageGroup = document.getElementById('ageGroup').value;
    const generateBtn = document.getElementById('generate-btn');
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('error-message');
    const storyOutput = document.getElementById('story-output');
    
    // Validate main prompt
    if (!mainPrompt) {
        showError('Please tell us about your hero\'s adventure!');
        return;
    }
    
    // Reset UI
    errorMessage.style.display = 'none';
    storyOutput.style.display = 'none';
    
    // Collect additional inputs
    // Use existing data or get new values
    promptData = {
        mainPrompt,
        ageGroup,
        moral: document.getElementById('moral')?.value.trim() || '',
        creature: document.getElementById('creature')?.value.trim() || '',
        magic: document.getElementById('magic')?.value.trim() || '',
        vibe: document.getElementById('vibe')?.value.trim() || '',
        ...promptData  // Allow overrides from customData
    };
    
    // Show loading state
    generateBtn.disabled = true;
    generateBtn.querySelector('.button-text').style.opacity = '0.5';
    generateBtn.querySelector('.button-loader').style.display = 'block';
    
    // Store current data for potential regeneration
    window.currentPromptData = { ...promptData };
    
    try {
        const response = await fetch('/story/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(promptData)
        });
        
        // Log the raw response for debugging
        console.log('Response status:', response.status);
        const responseText = await response.text();
        console.log('Response text:', responseText);
        
        // Try to parse as JSON
        let data;
        try {
            data = JSON.parse(responseText);
        } catch (e) {
            throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}...`);
        }
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to generate story');
        }
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        const storyContent = document.getElementById('story-content');
        storyContent.textContent = data.story;
        storyOutput.style.display = 'block';
        
        // Check if story seems complete
        const isComplete = checkStoryCompletion(data.story);
        document.getElementById('incomplete-warning').style.display = 
            isComplete ? 'none' : 'block';
        
    } catch (error) {
        showError(error.message);
    } finally {
        // Re-enable button and hide loading
        generateBtn.disabled = false;
        generateBtn.querySelector('.button-text').style.opacity = '1';
        generateBtn.querySelector('.button-loader').style.display = 'none';
    }
}

function showError(message) {
    const errorMessage = document.getElementById('error-message');
    errorMessage.textContent = message;
    errorMessage.style.display = 'block';
}
</script>

<style>
.story-creator {
    max-width: 800px;
    margin: 2rem auto;
    padding: 1rem;
}

h1 {
    color: #2c3e50;
    text-align: center;
    margin-bottom: 2rem;
}

.input-field {
    margin-bottom: 2rem;
}

.additional-fields .input-field {
    margin-bottom: 1.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #eee;
}

.additional-fields .input-field:first-child {
    border-top: none;
}

.input-field textarea {
    width: 100%;
    padding: 0.8rem;
    margin: 0.5rem 0;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s;
}

.input-field textarea:focus {
    border-color: #4CAF50;
    outline: none;
}

.input-field label {
    color: #666;
    font-size: 1rem;
}

.secondary-button {
    background: none;
    border: 2px solid #4CAF50;
    color: #4CAF50;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    margin: 1rem 0;
    transition: all 0.3s;
    display: block;
    width: 100%;
}

.secondary-button:hover {
    background: #4CAF50;
    color: white;
}

.generate-button {
    padding: 0.5rem 1rem;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
    margin-top: 1rem;
    width: 100%;
    font-size: 1.1em;
    position: relative;
}

.generate-button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

.loading {
    text-align: center;
    margin: 2rem 0;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #4CAF50;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.error-message {
    padding: 1rem;
    background-color: #ffebee;
    color: #c62828;
    border-radius: 4px;
    margin: 1rem 0;
}

.story-output {
    padding: 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    white-space: pre-wrap;
}

/* Style story section headers */
.story-output h4 {
    color: #4CAF50;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    font-size: 1.2rem;
}

.additional-fields {
    display: none;
    margin-top: 1rem;
    opacity: 0;
    transition: opacity 0.3s ease-out;
}

.additional-fields.visible {
    display: block;
    opacity: 1;
}

.button-loader {
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #4CAF50;
    border-radius: 50%;
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    animation: spin 1s linear infinite;
}

/* Age group selector styles */
.age-group-selector {
    margin-bottom: 1.5rem;
    padding: 0.5rem 0;
}

.age-group-selector label {
    display: block;
    color: #666;
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.age-select {
    width: 100%;
    padding: 0.8rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    background-color: white;
    cursor: pointer;
    transition: border-color 0.3s;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
}

.age-select:focus {
    border-color: #4CAF50;
    outline: none;
}

/* Required field styling */
.required-label::after {
    content: "*";
    color: #e53935;
    margin-left: 4px;
}

/* Responsive adjustments */
@media (max-width: 600px) {
    .story-creator {
        margin: 1rem;
        padding: 0.5rem;
    }

    .input-field textarea {
        font-size: 0.9rem;
    }

    h1 {
        font-size: 1.5rem;
    }
}

/* Placeholder styling */
.materialize-textarea::placeholder {
    color: #9e9e9e;
    font-style: italic;
    opacity: 0.8;
}
</style>
{% endblock %} 